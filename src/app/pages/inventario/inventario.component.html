<section class="card inventario">
  <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
    <h2 style="margin:0;">Inventario</h2>
    <span style="color:var(--muted);">{{ data.productos().length }} registros</span>
    <span style="margin-left:auto"></span>
    <span *ngIf="readOnly" style="color:var(--muted); font-size:12px;">Modo CSV: solo lectura</span>
  </div>

  <div class="card" style="margin-top:12px;" *ngIf="!readOnly">
    <form #prodForm="ngForm" (ngSubmit)="add()" novalidate class="form-grid">
      <label>Producto <input type="text" [(ngModel)]="nuevo.nombre" name="nombre" required />
        <div *ngIf="prodForm.submitted && !nuevo.nombre?.trim()" style="color:#c0392b; font-size:12px;">Campo requerido</div>
      </label>
      <label>Stock <input type="number" [(ngModel)]="nuevo.stock" name="stock" min="0" required />
        <div *ngIf="prodForm.submitted && !(Number(nuevo.stock)>=0)" style="color:#c0392b; font-size:12px;">Debe ser >= 0</div>
      </label>
      <label>Precio <input type="number" [(ngModel)]="nuevo.precio" name="precio" min="0" step="0.01" required />
        <div *ngIf="prodForm.submitted && !(Number(nuevo.precio)>=0)" style="color:#c0392b; font-size:12px;">Debe ser >= 0</div>
      </label>
      <label>Costo <input type="number" [(ngModel)]="nuevo.costo" name="costo" min="0" step="0.01" required />
        <div *ngIf="prodForm.submitted && !(Number(nuevo.costo)>=0)" style="color:#c0392b; font-size:12px;">Debe ser >= 0</div>
      </label>
      <div style="display:flex; align-items:flex-end;">
        <button class="btn icon" type="submit" [disabled]="prodForm.invalid" aria-label="Agregar">
          <span class="btn-icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M11 11V6h2v5h5v2h-5v5h-2v-5H6v-2h5z"/></svg></span>
          <span class="btn-label">Agregar</span>
        </button>
      </div>
    </form>
  </div>

  <div class="table-scroll" style="margin-top:12px;">
  <table>
    <thead>
      <tr>
        <th>Producto</th>
        <th class="num col-stock">Stock</th>
        <th class="num col-precio">Precio</th>
        <th class="num col-costo">Costo</th>
        <th class="col-actions" style="width:160px;"></th>
      </tr>
    </thead>
    <tbody>
      <ng-container *ngFor="let p of data.productos()">
      <tr class="clickable" (click)="toggleRow(p.id)" [class.expanded]="isExpanded(p.id)">
          <td [ngClass]="p.stock <= 5 ? 'stock-low' : (p.stock <= 10 ? 'stock-mid' : 'stock-ok')">{{ p.nombre }}</td>
          <td class="num col-stock" [ngClass]="p.stock <= 5 ? 'stock-low' : (p.stock <= 10 ? 'stock-mid' : 'stock-ok')">{{ p.stock }}</td>
          <td class="num col-precio">{{ p.precio | currency:'USD' }}</td>
          <td class="num col-costo">{{ p.costo | currency:'USD' }}</td>
          <td class="col-actions">
            <div class="actions" (click)="$event.stopPropagation()">
              <button class="btn secondary icon" (click)="startEdit(p)" [disabled]="readOnly" aria-label="Editar">
                <span class="btn-icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zm15.66-10.21a1 1 0 000-1.41L16.37 3.29a1 1 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></span>
                <span class="btn-label">Editar</span>
              </button>
              <button class="btn danger icon" (click)="remove(p.id)" [disabled]="readOnly" aria-label="Eliminar">
                <span class="btn-icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 6h18v2H3zM5 8h14v12H5zM9 4h6v2H9z"/></svg></span>
                <span class="btn-label">Eliminar</span>
              </button>
            </div>
          </td>
      </tr>
      <tr class="details-row" [class.editing]="editId === p.id">
        <td colspan="5">
          <ng-container *ngIf="editId === p.id; else prodDetails">
            <div class="form-grid" style="align-items:flex-end;">
              <label>Producto <input type="text" [(ngModel)]="editModel.nombre" name="edit_nombre_{{p.id}}" required /></label>
              <label>Stock <input type="number" [(ngModel)]="editModel.stock" name="edit_stock_{{p.id}}" min="0" required /></label>
              <label>Precio <input type="number" [(ngModel)]="editModel.precio" name="edit_precio_{{p.id}}" min="0" step="0.01" required /></label>
              <label>Costo <input type="number" [(ngModel)]="editModel.costo" name="edit_costo_{{p.id}}" min="0" step="0.01" required /></label>
              <div class="actions" (click)="$event.stopPropagation()">
                <button class="btn icon" (click)="save()" [disabled]="!editModel.nombre?.trim() || editModel.stock<0 || editModel.precio<0 || editModel.costo<0" aria-label="Guardar">
                  <span class="btn-icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M17 3H5a2 2 0 00-2 2v14h18V7l-4-4zM6 5h8v4H6V5zm6 14a3 3 0 110-6 3 3 0 010 6z"/></svg></span>
                  <span class="btn-label">Guardar</span>
                </button>
                <button class="btn secondary icon" (click)="cancelEdit()" type="button" aria-label="Cancelar">
                  <span class="btn-icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 6l12 12M6 18L18 6"/></svg></span>
                  <span class="btn-label">Cancelar</span>
                </button>
              </div>
            </div>
          </ng-container>
          <ng-template #prodDetails>
            <div style="display:flex; flex-direction:column; gap:6px;">
              <div><strong>Precio:</strong> {{ p.precio | currency:'USD' }}</div>
              <div><strong>Costo:</strong> {{ p.costo | currency:'USD' }}</div>
              <div class="actions" (click)="$event.stopPropagation()">
                <button class="btn secondary icon" (click)="startEdit(p)" [disabled]="readOnly" aria-label="Editar">
                  <span class="btn-icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zm15.66-10.21a1 1 0 000-1.41L16.37 3.29a1 1 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></span>
                  <span class="btn-label">Editar</span>
                </button>
                <button class="btn danger icon" (click)="remove(p.id)" [disabled]="readOnly" aria-label="Eliminar">
                  <span class="btn-icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 6h18v2H3zM5 8h14v12H5zM9 4h6v2H9z"/></svg></span>
                  <span class="btn-label">Eliminar</span>
                </button>
              </div>
            </div>
          </ng-template>
        </td>
      </tr>
      </ng-container>
    </tbody>
  </table>
  </div>
</section>
<div class="toast" *ngIf="toast">{{ toast }}</div>

